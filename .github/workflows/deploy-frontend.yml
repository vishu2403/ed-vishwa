name: Deploy Frontend to inaivers.com

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'scripts/deploy_frontend.sh'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  FRONTEND_S3_BUCKET: ${{ secrets.FRONTEND_S3_BUCKET }}
  TARGET_INSTANCE_ID: ${{ secrets.TARGET_INSTANCE_ID }}
  FRONTEND_REMOTE_DIR: ${{ secrets.FRONTEND_REMOTE_DIR }}

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Package build artifact
        run: |
          tar -czf frontend-dist.tar.gz -C frontend/dist .

      - name: Upload artifact to S3
        env:
          ARTIFACT_KEY: frontend/dist-${{ github.sha }}.tar.gz
        run: |
          aws s3 cp frontend-dist.tar.gz "s3://${{ env.FRONTEND_S3_BUCKET }}/$ARTIFACT_KEY"
          echo "ARTIFACT_KEY=$ARTIFACT_KEY" >> $GITHUB_ENV

      - name: Deploy via SSM
        env:
          ARTIFACT_KEY: ${{ env.ARTIFACT_KEY }}
        run: |
          set -e
          ARTIFACT_PATH="s3://${{ env.FRONTEND_S3_BUCKET }}/$ARTIFACT_KEY"
          
          # Add debug output
          echo "Starting deployment with artifact: $ARTIFACT_PATH"
          echo "Target instance: ${{ env.TARGET_INSTANCE_ID }}"
          echo "Remote directory: ${{ env.FRONTEND_REMOTE_DIR }}"
          
          PARAMS=$(jq -n --arg artifact "$ARTIFACT_PATH" --arg remote "${{ env.FRONTEND_REMOTE_DIR }}" '{
            commands: [
              "set -ex",
              "echo \"Starting deployment script...\"",
              "ARTIFACT=\($artifact)",
              "TMP=/tmp/frontend-dist",
              "echo \"Downloading artifact from S3...\"",
              "aws s3 cp \"$ARTIFACT\" /tmp/frontend-dist.tar.gz || { echo \"Failed to download from S3\"; exit 1; }",
              "echo \"Creating temp directory...\"",
              "rm -rf \"$TMP\" && mkdir -p \"$TMP\"",
              "echo \"Extracting artifact...\"",
              "tar -xzf /tmp/frontend-dist.tar.gz -C \"$TMP\" || { echo \"Failed to extract artifact\"; exit 1; }",
              "echo \"Changing to target directory: \($remote)\"",
              "cd \"\($remote)\" || { echo \"Failed to change directory\"; exit 1; }",
              "echo \"Running deploy script...\"",
              "BUILD_DIR=$TMP SKIP_NPM_INSTALL=1 SKIP_BUILD=1 bash -x scripts/deploy_frontend.sh || { echo \"Deployment script failed\"; exit 1; }",
              "echo \"Cleaning up...\"",
              "rm -f /tmp/frontend-dist.tar.gz",
              "echo \"Deployment completed successfully\""
            ]
          }')
          
          echo "Sending SSM command..."
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${{ env.TARGET_INSTANCE_ID }}" \
            --comment "Deploy frontend $ARTIFACT_KEY" \
            --parameters "$PARAMS" \
            --query 'Command.CommandId' --output text)
          
          if [ -z "$COMMAND_ID" ]; then
            echo "❌ Failed to send SSM command"
            exit 1
          fi
          
          echo "Waiting for command to complete (ID: $COMMAND_ID)..."
          if ! aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "${{ env.TARGET_INSTANCE_ID }}"; then
            echo "⚠️  SSM command execution failed or timed out"
          fi
          
          # Get and display full command output
          echo -e "\n=== Command Output ==="
          if ! OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.TARGET_INSTANCE_ID }}" \
            --output json 2>&1); then
            echo "❌ Failed to get command invocation output"
            echo "$OUTPUT"
            exit 1
          fi
          
          # Check if OUTPUT is valid JSON
          if ! echo "$OUTPUT" | jq empty 2>/dev/null; then
            echo "❌ Invalid JSON response from AWS SSM"
            echo "$OUTPUT"
            exit 1
          fi
          
          # Output both stdout and stderr
          echo -e "\n=== Standard Output ==="
          echo "$OUTPUT" | jq -r '.StandardOutputContent // "No output"'
          
          echo -e "\n=== Standard Error ==="
          echo "$OUTPUT" | jq -r '.StandardErrorContent // "No errors"'
          
          # Check command status
          STATUS=$(echo "$OUTPUT" | jq -r '.Status // "Unknown"')
          echo -e "\nCommand status: $STATUS"
          
          if [ "$STATUS" != "Success" ]; then
            echo -e "\n❌ Deployment failed with status: $STATUS"
            exit 1
          fi
          
          echo -e "\n✅ Deployment completed successfully!"

      - name: Remove artifact from S3
        if: always()
        env:
          ARTIFACT_KEY: ${{ env.ARTIFACT_KEY }}
        run: |
          if [[ -n "$ARTIFACT_KEY" ]]; then
            echo "Cleaning up artifact: $ARTIFACT_KEY"
            aws s3 rm "s3://${{ env.FRONTEND_S3_BUCKET }}/$ARTIFACT_KEY" || echo "Failed to remove artifact (may not exist)"
          fi